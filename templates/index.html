<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <style>
        body { margin:0; font-family: Arial, sans-serif; background: #f5f5f5; color: #333; }
        .container { display: flex; height: 100vh; }
        .side-menu { width: 250px; background: #2f353e; color: #eee; display: flex; flex-direction: column; overflow-y: auto; }
        .side-menu h2 { font-size: 1.2rem; margin: 20px; color: #ccc; }
        .category { margin:0; padding:0; border-bottom:1px solid #444; }
        .category-title { padding:10px 20px; cursor:pointer; background:#394049; font-weight:bold; user-select:none; }
        .category-items { display:none; flex-direction:column; }
        .category-items button { padding:10px 20px; border:none; text-align:left; background:#2f353e; color:#eee; cursor:pointer; outline:none; }
        .category-items button:hover { background:#3f4650; }
        .main-area { flex:1; display:flex; flex-direction:column; background:#fff; }
        .terminal-top-bar { background:#ddd; padding:10px; display:flex; justify-content:flex-end; align-items:center; }
        .terminal-top-bar select { padding:5px; margin-left:10px; }
        .terminal-container { flex:1; background:#1e1e1e; display:flex; flex-direction:column; overflow:hidden; }
        #terminal { flex:1; overflow:hidden; }
        .hidden-input {display: none; margin-left: 25px; padding:10px 10px; background:#6c7076;} 
        .hidden-input-label {font-size: 12px; color: #373737; margin: 0px; display: block;}
        .hidden-input button {padding:2px 4px; color:#eee; background: #373737}
        .hidden-input button:hover { background:#3f4650; }
            
  
    </style>
</head>
<body>
    <div class="container">
        <div class="side-menu">
            <h2>Commands</h2>
            <div class="category">
                <div class="category-title">Environment</div>
                <div class="category-items">
                    <button data-command="echo hello">echo hello</button>
                    <button data-command="uname -a">os version</button>
                    <button data-command="ifconfig">ip and mac</button>
                    <button data-command="top">running processes</button>
                    <button data-command="which python">python location</button>
                    <button data-command="pip list -v">modules locations</button>
                    <button data-command="echo &quot;PATH directories (from current terminal):&quot; &amp;&amp; echo &quot;---------------------------------&quot; &amp;&amp; echo &quot;$PATH&quot; | tr ':' '\n' | nl">show PATH content</button>
                    <button data-command="conda env list | tail -n +3 | awk '{print $1}' | while read env; do if [ -n &quot;$env&quot; ]; then echo &quot;Environment: $env&quot;; conda run -n &quot;$env&quot; python --version 2&gt;/dev/null; conda list -n &quot;$env&quot; | awk '{print $1&quot;=&quot;$2}' | grep -v '^[#@]' | tr '\n' ',' | sed 's/,$//'; echo; fi; done">see all conda environments</button>
                    
                    <!-- button with input fields that will apear after click-->
                    <button onclick="toggleVisibility(this.nextElementSibling)">create new conda environment (...)</button>
                      <div class="hidden-input">
                          <p class="hidden-input-label">environment name:</p>
                          <input type="text" name="word" placeholder="bio" size="15" required oninput="this.nextElementSibling.setAttribute('data-command', 'conda create -n \'' + this.value.trim() + '\' python=3.11')">
                          <button class="hidden-input-ok" type="submit" data-command="this will be replaced after user types on the imput above">OK</button>
                      </div>


                </div>
            </div>
            <div class="category">
                <div class="category-title">GIT</div>
                <div class="category-items">
                    
                    <button data-command="git init |||||| git clone xxx">init or clone</button>
                    
                    <button data-command="xxx">pull</button>

                    <!-- button with input fields that will apear after click-->
                    <button onclick="toggleVisibility(this.nextElementSibling)">add, commit (...)</button>
                      <div class="hidden-input">
                          <p class="hidden-input-label">commit message:</p>
                          <input type="text" name="word" placeholder="" size="15" required oninput="this.nextElementSibling.setAttribute('data-command', 'git add . && git commit -m \'' + this.value.trim() + '\'')">
                          <button class="hidden-input-ok" type="submit" data-command="this will be replaced after user types on the imput above">OK</button>
                      </div>

                    <!--button that will send bash code directly-->
                    <button data-command="git push origin $(git rev-parse --abbrev-ref HEAD)">push (current branch)</button>
                    
                    <!-- button with input fields that will apear after click-->
                    <button onclick="toggleVisibility(this.nextElementSibling)">reset (...)</button>
                      <div class="hidden-input">
                          <p class="hidden-input-label">go back to this commit </p>
                          <input type="text" name="word" placeholder="HEAD" size="15" required oninput="this.nextElementSibling.nextElementSibling.setAttribute('data-command', 'git reset ' + this.value.trim() + ' --hard' )">
                          <p >ATTENTION: all posterior changes will be deleted! </p>
                          <button class="hidden-input-ok" type="submit" data-command="this will be replaced after user types on the imput above">OK</button>
                      </div>

                    <!--button that will send bash code directly-->
                    <button data-command="git branch">see all branches</button>

                    <!-- button with input fields that will apear after click-->
                    <button onclick="toggleVisibility(this.nextElementSibling)">create new branch (...)</button>
                    <div class="hidden-input">
                        <p class="hidden-input-label">new branch name:</p>
                        <input type="text" name="word" placeholder="#123_fix_something" size="15" required oninput="this.nextElementSibling.setAttribute('data-command', 'git branch ' + this.value.trim() )">
                        <button class="hidden-input-ok" type="submit" data-command="this will be replaced after user types on the imput above">OK</button>
                    </div>

                    <!-- button with input fields that will apear after click. but this one have two inputs-->
                    <button onclick="toggleVisibility(this.nextElementSibling)">merge (...)</button>
                    <div class="hidden-input"> 
                        <p class="hidden-input-label">source branch:</p>
                        <input type="text" id="branch-x" name="branch-x" placeholder="#123_fix_something" size="15" required>
                        
                        <p class="hidden-input-label">destination branch:</p>
                        <input type="text" id="branch-y" name="branch-y" placeholder="master" size="15" required>
                        
                        <button 
                            class="hidden-input-ok" 
                            type="button" 
                            data-command="will change after click in the ok button" 
                            onclick="this.setAttribute('data-command', 'git checkout ' + document.getElementById('branch-y').value.trim() + ' && git merge ' + document.getElementById('branch-x').value.trim() + ' --no-ff'); console.log(this.getAttribute('data-command'));">
                            OK
                        </button>
                    </div>

                    



                </div>
            </div>


            <div class="category">
                <div class="category-title">Search for files</div>
                <div class="category-items">
                    <button data-command='printf "%-30s %-10s %-10s %-15s\n" "Name" "Size" "Lines" "Permissions"; for file in .* *; do [ -e "$file" ] || continue; size=$(du -sh "$file" 2>/dev/null | awk "{print \$1}"); perms=$(stat -c "%A" "$file" 2>/dev/null); lines=$( [ -f "$file" ] && wc -l < "$file" || echo "N/A" ); printf "%-30s %-10s %-10s %-15s\n" "$file" "$size" "$lines" "$perms"; done'>ls (with extra infos)</button>
                    
                    <!-- button with input fields that will apear after click-->
                    <button onclick="toggleVisibility(this.nextElementSibling)">by name (...)</button>
                    <div class="hidden-input">
                        <p class="hidden-input-label">regex:</p>
                        <input type="text" name="word" placeholder="*enrique\.jpg" size="15" required
                               oninput="this.nextElementSibling.setAttribute('data-command', 'find . -regextype posix-extended -regex \'.*/' + this.value.trim() + '\'')">
                        <button class="hidden-input-ok" type="submit" data-command="this will be replaced after user types on the imput above">OK</button>
                    </div>


                    <!-- button with input fields that will apear after click-->
                    <button onclick="toggleVisibility(this.nextElementSibling)">by path (...)</button>
                    <div class="hidden-input">
                        <p class="hidden-input-label">regex:</p>
                        <input type="text" name="word" placeholder=".*sers/*enrique\.jpg" size="15" required oninput="this.nextElementSibling.setAttribute('data-command', 'find . -regextype posix-extended -regex \'' + this.value.trim() + '\'' )">
                        <button class="hidden-input-ok" type="submit" data-command="this will be replaced after user types on the imput above">OK</button>
                    </div>

                    
            
                    <!-- button with input fields that will apear after click-->
                    <button onclick="toggleVisibility(this.nextElementSibling)">by content (...)</button>
                    <div class="hidden-input">
                        <p class="hidden-input-label">regex:</p>
                        <input type="text" name="word" placeholder=".*mention lu at aprouve" size="15" required oninput="this.nextElementSibling.setAttribute('data-command', 'find . -type f -print | xargs grep \'' + this.value.trim() +'\'' )">
                        <button class="hidden-input-ok" type="submit" data-command="this will be replaced after user types on the imput above">OK</button>
                    </div>
                    
                </div>
            </div>



            <div class="category">
            <div class="category-title">Construct Molecules</div>
            <div class="category-items">
                <button data-command="xxx">download_and_clean_pdb</button>
                <button data-command="xxx">xxx create_line</button>
                <button data-command="xxx">xxx create_tape</button>
                <button data-command="xxx">xxx create_christal</button>
                <button data-command="xxx">create_peptide</button>
                <button data-command="xxx">xxx create_any_molecule</button>

            </div>
        </div>

        <div class="category">
            <div class="category-title">Construct MD System</div>
            <div class="category-items">
                <button data-command="xxx">pdb2molecule_in_solvent</button>
                <button data-command="xxx">void2peptide_in_solvent</button>
                <button data-command="xxx">pdb2molecule_in_membrane xxx</button>
                <button data-command="xxx">pdb2filled_box</button>

            </div>
        </div>

        <div class="category">
            <div class="category-title">Run MD</div>
            <div class="category-items">
                <button data-command="xxx">make_realistic</button>
                <button data-command="xxx">xxx run to see trajectories</button>
                <button data-command="xxx">xxx run FEP</button>

            </div>
        </div>

        <div class="category">
            <div class="category-title">MD Analysis</div>
            <div class="category-items">
                <button data-command="xxx">Ramachandran plot</button>
                <button data-command="xxx">DSSP</button>
                <button data-command="xxx">H bonds</button>
                <button data-command="xxx">Distance between 2 atoms</button>
                <button data-command="xxx">Aminoacid phi and psi</button>
                <button data-command="xxx">RMSD with respect to a reference</button>
                <button data-command="xxx">Gyration radius</button>
                <button data-command="xxx">SASA</button>
                <button data-command="xxx">Quadruopole</button>

                <form action="/do-stuff" method="POST">
                    <button type="submit">Do stuff {{ hi }}</button>
                </form>
                
                
            </div>
        </div>




            
        </div>
        <div class="main-area">
            <div class="terminal-top-bar">
                <span>Choose Terminal:</span>
                <select id="terminalSelector">
                    {% for shell in shells %}
                    <option value="{{ shell.name }}" {% if not shell.available %}disabled{% endif %}>
                        {{ shell.name }}{% if not shell.available %} (unavailable){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="terminal-container">
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script>
        // Determine correct protocol dynamically for WebSocket
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = protocol + window.location.host + "/ws";

        // Terminal initialization
        const term = new Terminal({
            cols: 80,
            rows: 24,
            fontSize: 14,
            theme: { background: '#1e1e1e', foreground: '#ffffff' }
        });
        term.open(document.getElementById('terminal'));

        let ws;
        let currentShell = document.getElementById('terminalSelector').value;

        function connectTerminal(shellType) {
            if (ws) ws.close();
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                ws.send(shellType);
                term.write(`\r\nConnected to ${shellType} shell\r\n`);
            };

            ws.onmessage = (event) => {
                term.write(event.data);
            };

            ws.onclose = () => {
                term.write("\r\n*** Disconnected from server ***\r\n");
            };
        }

        connectTerminal(currentShell);

        term.onData(data => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(data);
            }
        });

        document.getElementById('terminalSelector').addEventListener('change', (e) => {
            const selectedShell = e.target.value;
            currentShell = selectedShell;
            connectTerminal(currentShell);
        });

        // Safeguard for empty or invalid commands
        document.querySelectorAll('.category-items button').forEach(btn => {
            btn.addEventListener('click', () => {
                const command = btn.getAttribute('data-command');
                if (command && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(command + "\r");
                } else {
                    console.error("Invalid command or WebSocket not open");
                }
            });
        });

        // Toggle category visibility
        document.querySelectorAll('.category-title').forEach(title => {
            title.addEventListener('click', () => {
                const items = title.nextElementSibling;
                items.style.display = (items.style.display === 'flex') ? 'none' : 'flex';
            });
        });


        // Toggle visibility og an item inputs
        function toggleVisibility(element) {
        if (element.style.display === 'none' || element.style.display === '') {
        element.style.display = 'block';
        } else {
        element.style.display = 'none';
        }
}


    </script>
</body>
</html>
